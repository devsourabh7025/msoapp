{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///F:/NNBlog/my-app/lib/moongoose.js"],"sourcesContent":["import mongoose from \"mongoose\";\n\n// Don't check MONGODB_URI at module level - check it when connecting\n// This prevents build-time errors since env vars may not be available during build\nfunction getMongoDBUri() {\n  const uri =\n    process.env.MONGODB_URI ||\n    \"mongodb+srv://sourabhmalame:sourabh1234@pgadmin.evcqvgp.mongodb.net/?appName=pgadmin\";\n  if (!uri) {\n    throw new Error(\n      \"âŒ MONGODB_URI is missing. Please set it in your environment variables (Vercel: Settings > Environment Variables)\"\n    );\n  }\n  return uri;\n}\n\nlet cached = global._mongoose;\nif (!cached) cached = global._mongoose = { conn: null, promise: null };\n\n// Check if mongoose is already connected\nfunction isConnected() {\n  return mongoose.connection.readyState === 1;\n}\n\n/**\n * Connect to MongoDB database\n * Uses connection pooling and caching to reuse connections\n * Only connects once, subsequent calls reuse the existing connection\n * This should be called at login to establish the connection\n */\nexport async function connectDB() {\n  // If mongoose is already connected, return immediately (no need to check cache)\n  if (isConnected()) {\n    return mongoose.connection;\n  }\n\n  // If connection exists in cache and is still valid, return it\n  if (cached.conn && isConnected()) {\n    return cached.conn;\n  }\n\n  // If connection is in progress, wait for it\n  if (cached.promise) {\n    try {\n      cached.conn = await cached.promise;\n      return cached.conn;\n    } catch (error) {\n      cached.promise = null;\n      throw error;\n    }\n  }\n\n  // Get MongoDB URI (will throw error if not set)\n  const mongoUri = getMongoDBUri();\n\n  // Create new connection promise with optimized settings for slow networks\n  cached.promise = mongoose.connect(mongoUri, {\n    bufferCommands: false, // Fail fast if not connected\n    serverSelectionTimeoutMS: 30000, // Increased to 30 seconds for slow networks\n    socketTimeoutMS: 60000, // Increased socket timeout to 60 seconds\n    connectTimeoutMS: 30000, // Increased connection timeout to 30 seconds\n    maxPoolSize: 10, // Connection pool size\n    minPoolSize: 1, // Minimum connections\n    maxIdleTimeMS: 30000, // Close connections after 30 seconds of inactivity\n    retryWrites: true,\n    retryReads: true, // Retry reads on network errors\n    w: \"majority\",\n    // Additional options for slow/unstable networks\n    heartbeatFrequencyMS: 10000, // Check connection health every 10 seconds\n    serverSelectionRetryDelayMS: 5000, // Wait 5 seconds between retry attempts\n  });\n\n  try {\n    cached.conn = await cached.promise;\n    console.log(\"âœ… Mongoose connected to MongoDB\");\n\n    // Handle connection events\n    mongoose.connection.on(\"error\", (err) => {\n      console.error(\"MongoDB connection error:\", err);\n      cached.conn = null;\n      cached.promise = null;\n    });\n\n    mongoose.connection.on(\"disconnected\", () => {\n      console.warn(\"MongoDB disconnected\");\n      cached.conn = null;\n      cached.promise = null;\n    });\n\n    return cached.conn;\n  } catch (error) {\n    cached.promise = null;\n    cached.conn = null;\n    console.error(\"Failed to connect to MongoDB:\", error);\n\n    // Provide more helpful error messages\n    if (error.code === \"ECONNREFUSED\") {\n      console.error(\n        \"âŒ MongoDB connection refused. Please check:\\n\" +\n          \"1. Your MongoDB Atlas cluster is running\\n\" +\n          \"2. Your IP address is whitelisted in MongoDB Atlas\\n\" +\n          \"3. Your connection string is correct\\n\" +\n          \"4. Your network connection is working\"\n      );\n    } else if (error.name === \"MongoServerError\") {\n      console.error(\"âŒ MongoDB server error:\", error.message);\n    } else if (error.name === \"MongoNetworkError\") {\n      console.error(\"âŒ MongoDB network error:\", error.message);\n    }\n\n    throw error;\n  }\n}\n\n/**\n * Ensure database is connected (for routes that assume connection exists)\n * If not connected, will connect (fallback for routes called before login)\n */\nexport async function ensureConnected() {\n  if (isConnected()) {\n    return mongoose.connection;\n  }\n  // Fallback: connect if not already connected\n  return await connectDB();\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,qEAAqE;AACrE,mFAAmF;AACnF,SAAS;IACP,MAAM,MACJ,QAAQ,GAAG,CAAC,WAAW,IACvB;IACF;;IAKA,OAAO;AACT;AAEA,IAAI,SAAS,yDAAO,SAAS;AAC7B,IAAI,CAAC,QAAQ,SAAS,yDAAO,SAAS,GAAG;IAAE,MAAM;IAAM,SAAS;AAAK;AAErE,yCAAyC;AACzC,SAAS;IACP,OAAO,oHAAQ,CAAC,UAAU,CAAC,UAAU,KAAK;AAC5C;AAQO,eAAe;IACpB,gFAAgF;IAChF,IAAI,eAAe;QACjB,OAAO,oHAAQ,CAAC,UAAU;IAC5B;IAEA,8DAA8D;IAC9D,IAAI,OAAO,IAAI,IAAI,eAAe;QAChC,OAAO,OAAO,IAAI;IACpB;IAEA,4CAA4C;IAC5C,IAAI,OAAO,OAAO,EAAE;QAClB,IAAI;YACF,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;YAClC,OAAO,OAAO,IAAI;QACpB,EAAE,OAAO,OAAO;YACd,OAAO,OAAO,GAAG;YACjB,MAAM;QACR;IACF;IAEA,gDAAgD;IAChD,MAAM,WAAW;IAEjB,0EAA0E;IAC1E,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,UAAU;QAC1C,gBAAgB;QAChB,0BAA0B;QAC1B,iBAAiB;QACjB,kBAAkB;QAClB,aAAa;QACb,aAAa;QACb,eAAe;QACf,aAAa;QACb,YAAY;QACZ,GAAG;QACH,gDAAgD;QAChD,sBAAsB;QACtB,6BAA6B;IAC/B;IAEA,IAAI;QACF,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;QAClC,QAAQ,GAAG,CAAC;QAEZ,2BAA2B;QAC3B,oHAAQ,CAAC,UAAU,CAAC,EAAE,CAAC,SAAS,CAAC;YAC/B,QAAQ,KAAK,CAAC,6BAA6B;YAC3C,OAAO,IAAI,GAAG;YACd,OAAO,OAAO,GAAG;QACnB;QAEA,oHAAQ,CAAC,UAAU,CAAC,EAAE,CAAC,gBAAgB;YACrC,QAAQ,IAAI,CAAC;YACb,OAAO,IAAI,GAAG;YACd,OAAO,OAAO,GAAG;QACnB;QAEA,OAAO,OAAO,IAAI;IACpB,EAAE,OAAO,OAAO;QACd,OAAO,OAAO,GAAG;QACjB,OAAO,IAAI,GAAG;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAE/C,sCAAsC;QACtC,IAAI,MAAM,IAAI,KAAK,gBAAgB;YACjC,QAAQ,KAAK,CACX,kDACE,+CACA,yDACA,2CACA;QAEN,OAAO,IAAI,MAAM,IAAI,KAAK,oBAAoB;YAC5C,QAAQ,KAAK,CAAC,2BAA2B,MAAM,OAAO;QACxD,OAAO,IAAI,MAAM,IAAI,KAAK,qBAAqB;YAC7C,QAAQ,KAAK,CAAC,4BAA4B,MAAM,OAAO;QACzD;QAEA,MAAM;IACR;AACF;AAMO,eAAe;IACpB,IAAI,eAAe;QACjB,OAAO,oHAAQ,CAAC,UAAU;IAC5B;IACA,6CAA6C;IAC7C,OAAO,MAAM;AACf"}},
    {"offset": {"line": 155, "column": 0}, "map": {"version":3,"sources":["file:///F:/NNBlog/my-app/models/Settings.js"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst SettingsSchema = new mongoose.Schema(\r\n  {\r\n    key: {\r\n      type: String,\r\n      required: true,\r\n      unique: true,\r\n    },\r\n    value: {\r\n      type: mongoose.Schema.Types.Mixed,\r\n      required: true,\r\n    },\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nexport default mongoose.models.Settings || mongoose.model(\"Settings\", SettingsSchema);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,iBAAiB,IAAI,oHAAQ,CAAC,MAAM,CACxC;IACE,KAAK;QACH,MAAM;QACN,UAAU;QACV,QAAQ;IACV;IACA,OAAO;QACL,MAAM,oHAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK;QACjC,UAAU;IACZ;AACF,GACA;IAAE,YAAY;AAAK;uCAGN,oHAAQ,CAAC,MAAM,CAAC,QAAQ,IAAI,oHAAQ,CAAC,KAAK,CAAC,YAAY"}},
    {"offset": {"line": 203, "column": 0}, "map": {"version":3,"sources":["file:///F:/NNBlog/my-app/app/api/settings/spotlight/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { ensureConnected } from \"@/lib/moongoose\";\nimport Settings from \"@/models/Settings\";\nimport jwt from \"jsonwebtoken\";\nimport User from \"@/models/User\";\n\nfunction getJWTSecret() {\n  return process.env.JWT_SECRET || \"your-secret-key\";\n}\n\n// Helper function to optimize post data\nfunction optimizePostData(post) {\n  if (!post || typeof post !== 'object') return post;\n  \n  const optimized = {\n    _id: post._id,\n    slug: post.slug,\n    title: post.title,\n    featuredImage: post.featuredImage,\n    excerpt: post.excerpt,\n    category: post.category,\n    publishedAt: post.publishedAt,\n  };\n  \n  if (post.author) {\n    if (typeof post.author === 'object' && post.author.name) {\n      optimized.author = { name: post.author.name };\n    } else if (typeof post.author === 'string') {\n      optimized.author = post.author;\n    } else {\n      optimized.author = { name: 'Editorial Team' };\n    }\n  }\n  \n  return optimized;\n}\n\n// GET - Fetch spotlight section data\nexport async function GET() {\n  try {\n    const dbOperation = async () => {\n      await ensureConnected();\n\n      // Use lean() for faster queries\n      // Spotlight content and settings are stored as separate database entries\n      const [spotlightContentData, spotlightSettingsData] = await Promise.all([\n        Settings.findOne({ key: \"homepageSpotlightContent\" }).lean().maxTimeMS(3000),\n        Settings.findOne({ key: \"homepageSpotlightSettings\" }).lean().maxTimeMS(3000),\n      ]);\n\n      return { spotlightContentData, spotlightSettingsData };\n    };\n\n    // Reduced timeout to 5 seconds for faster failure\n    const timeoutPromise = new Promise((_, reject) => {\n      setTimeout(() => reject(new Error(\"Database operation timeout\")), 5000);\n    });\n\n    const { spotlightContentData, spotlightSettingsData } = await Promise.race([\n      dbOperation(),\n      timeoutPromise,\n    ]);\n\n    // Get spotlight content from separate database entry\n    let spotlightContent = [];\n    if (spotlightContentData?.value && Array.isArray(spotlightContentData.value)) {\n      spotlightContent = spotlightContentData.value.map(optimizePostData);\n    }\n\n    // Get spotlight settings from separate database entry\n    const spotlightSettings = spotlightSettingsData?.value || {\n      title: \"SpotLight\",\n      subtitle: \"Featured Stories & Insights\",\n      showSection: true,\n    };\n\n    return NextResponse.json(\n      {\n        spotlight: spotlightContent,\n        settings: spotlightSettings,\n      },\n      {\n        status: 200,\n        headers: {\n          'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=120',\n        },\n      }\n    );\n  } catch (error) {\n    console.error(\"Error fetching spotlight section:\", error);\n    // Return empty data immediately on error\n    return NextResponse.json(\n      {\n        spotlight: [],\n        settings: {\n          title: \"SpotLight\",\n          subtitle: \"Featured Stories & Insights\",\n          showSection: true,\n        },\n      },\n      {\n        status: 200,\n        headers: {\n          'Cache-Control': 'no-store',\n        },\n      }\n    );\n  }\n}\n\n// PUT - Update spotlight section data (admin only)\nexport async function PUT(request) {\n  try {\n    const body = await request.json();\n    const { spotlight, settings } = body;\n\n    // Verify authentication - check cookies first (like homepage API)\n    const token = request.cookies.get(\"token\")?.value;\n    if (!token) {\n      return NextResponse.json(\n        { error: \"Not authenticated\", message: \"Please log in to save settings\" },\n        { status: 401 }\n      );\n    }\n\n    let decoded;\n    try {\n      decoded = jwt.verify(token, getJWTSecret());\n    } catch (error) {\n      return NextResponse.json({ error: \"Invalid token\" }, { status: 401 });\n    }\n\n    // Verify user is admin\n    await ensureConnected();\n    const user = await User.findById(decoded.userId);\n    if (!user || user.role !== \"ADMIN\") {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    const saveOperation = async () => {\n      const saveWithRetry = async (key, value, type, maxRetries = 2) => {\n        for (let attempt = 1; attempt <= maxRetries; attempt++) {\n          try {\n            console.log(`ðŸ’¾ Saving ${type} to database... (Attempt ${attempt}/${maxRetries})`);\n            const result = await Settings.findOneAndUpdate(\n              { key },\n              { value },\n              { upsert: true, new: true }\n            ).maxTimeMS(15000);\n            \n            console.log(`âœ… ${type} saved to database`);\n            return result;\n          } catch (error) {\n            console.error(`âŒ Failed to save ${type} to database (Attempt ${attempt}):`, error.message);\n            if (attempt === maxRetries) {\n              throw error;\n            }\n            await new Promise(resolve => setTimeout(resolve, 2000));\n          }\n        }\n      };\n\n      // Save spotlight content\n      if (spotlight !== undefined && spotlight !== null) {\n        const optimizedSpotlight = Array.isArray(spotlight) \n          ? spotlight.map(optimizePostData) \n          : [];\n        await saveWithRetry(\"homepageSpotlightContent\", optimizedSpotlight, \"spotlight content\");\n      }\n\n      // Save spotlight settings separately to database (key: \"homepageSpotlightSettings\")\n      if (settings !== undefined && settings !== null) {\n        await saveWithRetry(\"homepageSpotlightSettings\", settings, \"spotlight settings\");\n      }\n    };\n\n    const timeoutPromise = new Promise((_, reject) => {\n      setTimeout(() => reject(new Error(\"Database operation timeout\")), 35000);\n    });\n\n    await Promise.race([saveOperation(), timeoutPromise]);\n\n    return NextResponse.json({\n      message: \"Spotlight section saved successfully\",\n    });\n  } catch (error) {\n    console.error(\"Error saving spotlight section:\", error);\n    if (error.message?.includes(\"timeout\")) {\n      return NextResponse.json(\n        { error: \"Request timed out\", message: \"The operation took too long. Please try again.\" },\n        { status: 504 }\n      );\n    }\n    return NextResponse.json(\n      { error: \"Failed to save spotlight section\", message: error.message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}